<!--pip install django-widget-tweaks-->
{% extends 'myapp/index.html' %}

 {% block content %}
{% load static %}


  <div class="container mt-5">
    <h2>بارگزاری مدارک</h2>
    <div id="fileuploaded" class="mt-3"></div>
    <div class="row" id="buttonsRow">
      <!-- Buttons will be dynamically added here -->
    </div>
    <div class="progress mt-3" style="display: none;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <input type="hidden" id="code" value='{{cp}}' />
    
    <input type="hidden" id="code_meli" value='{{code_meli}}' />
    <input type="hidden" id="file_types" value='{{file_types}}' />
    <input type="hidden" id="files" value='{{files}}' />

    
    <div id="filePreviews" class="mt-3"></div>
    
  </div>
  <style>
    /* Custom CSS for image previews */
    #filePreviews {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .preview {
      max-width: 200px;
    }
  </style>
  <!-- Bootstrap JS and jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- Custom JavaScript -->
  <script>
    // Function to handle file selection and upload for each button
    function handleFileUpload(buttonValue,buttonType) {
      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      fileInput.onchange = function(event) {
        var file = event.target.files[0];
        if (!file) {
          return;
        }

        var formData = new FormData();
        formData.append('file', file);
        // Replace 'YOUR_UPLOAD_URL_HERE' with the actual server-side endpoint to handle file upload
        var url = '/upload/?cp='+$("#code").val()+'&code_meli='+$("#code_meli").val()+'&btnType='+buttonType;

        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);

        var progressBar = document.querySelector('.progress-bar');
        progressBar.style.width = '0%';
        progressBar.innerHTML = '0%';

        xhr.upload.onprogress = function(event) {
          var progress = Math.round((event.loaded / event.total) * 100);
          progressBar.style.width = progress + '%';
          progressBar.innerHTML = progress + '%';
        };

        xhr.onload = function() {
          progressBar.innerHTML = 'Upload complete!';
          progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
          createPreview(file, buttonValue);
          removeButton(buttonValue);
        };

        xhr.onerror = function() {
          alert('Error uploading the file. Please try again later.');
        };

        xhr.send(formData);
      };

      fileInput.click();
    }

    // Function to create preview for each uploaded image
    function createPreview(file,buttonValue) {
      var reader = new FileReader();
      reader.onload = function() {
        var filePreviews = document.getElementById('filePreviews');

        var previewDiv = document.createElement('div');
        previewDiv.className = 'preview';
        previewDiv.innerHTML = '<h5>'+ buttonValue + ' Image Preview:</h5>' +
          '<img src="' + reader.result + '" class="img-thumbnail" style="max-width: 200px;">';

        filePreviews.appendChild(previewDiv);
      };

      reader.readAsDataURL(file);
    }
    function createPreview2(files) {
      
        var filePreviews = document.getElementById('fileuploaded');
        for(i in files){
        console.log(files[i]);
        var previewDiv = document.createElement('div');
        previewDiv.className = 'preview';
        previewDiv.innerHTML = '<h5>' + ' Image Preview:</h5>' +
          '<img src="../media/' + files[i].msgFile + '" class="img-thumbnail" style="max-width: 200px;">';

        filePreviews.appendChild(previewDiv);
        }
      

      
    }

    // Function to remove the button after upload
    function removeButton(buttonValue) {
      var buttonsRow = document.getElementById('buttonsRow');
      var buttons = buttonsRow.getElementsByTagName('button');
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i].value == buttonValue) {
          buttons[i].remove();
          break;
        }
      }
    }
    var buttonsData = [
          { name: 'صفحه اول شناسنامه',type:1 },
          { name: 'صفحه دوم شناسنامه',type:2 },
          { name: 'صفحه انهایی شناسنامه',type:3 },
          { name: 'صفحه اول شناسنامه همسر',type:4 },
          { name: 'صفحه اول شناسنامه فرزند',type:5 },
          { name: 'افزودن شناسنامه فرزند',type:6 },
          { name: 'Button G',type:7 },
          { name: 'Button H',type:8 },
          { name: 'Button I',type:9 },
          { name: 'Button J',type:10 }
        ];
    let valueString = $("#file_types").val();
    let valueArray = JSON.parse(valueString.replace(/'/g, '"'));
    //console.log(valueArray);
    buttonsData = buttonsData.filter(button => !valueArray.some(valueItem => valueItem.msgFiledtype === button.type));
    let valueStringfiles = $("#files").val();
    let valueArrayfiles = JSON.parse(valueStringfiles.replace(/'/g, '"'));
    //console.log(valueArrayfiles);
    createPreview2(valueArrayfiles);

    // Create 10 buttons dynamically
    var buttonsRow = document.getElementById('buttonsRow');
    for (var i = 0; i < buttonsData.length; i++) {
      var button = document.createElement('button');
      button.type = 'button';
      button.className = 'btn btn-primary btn-block mr-2';
      button.textContent = buttonsData[i].name;
      button.value = buttonsData[i].name;
      button.data_url=buttonsData[i].type;
      button.onclick = function() {
        handleFileUpload(this.value,this.data_url);
      };

      buttonsRow.appendChild(button);
    }
  </script>



{% endblock %}
